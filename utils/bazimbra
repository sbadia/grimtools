#!/usr/bin/ruby1.9.1
# Bazimbra -- rewrite of the text/plain part of Zimbra emails to make it readable
# Copyright (c) 2011 Lucas Nussbaum <lucas.nussbaum@loria.fr>
# License: WTFPL version 2 <http://sam.zoy.org/wtfpl/>

=begin
This script "Fixes" the text/plain part of mails generated by the Zimbra Web client
by piping the text/html part through w3m and using it as text/plain.

It requires the 'mail' ruby library.

Usage, from procmail:
# match only the version of Zimbra currently in use by INRIA (let's be optimistic)
:0
* ^X-Mailer: Zimbra 6.0.10.*ZimbraWebClient
{
   # backup copy of transformed emails, you never know
   :0c:
   .backup-zimbra/

   # pipe to script
   :0fw
   | $HOME/bin/bazimbra
}
=end

require 'mail'

# force external encoding to iso-8859-1
# as well as LC_ALL, for w3m
Encoding.default_external = 'iso-8859-1'
ENV['LC_ALL']='fr_FR.ISO-8859-1'

# create unfucked text version by piping the HTML part to w3m
msg = Mail.read_from_string STDIN.read
f = `mktemp /tmp/zimbra.XXXXXX.html`.chomp
File::open(f, 'w') do |f|
  f.puts msg.html_part.body.to_s
end
text = `w3m -cols 74 -dump #{f}`.force_encoding('iso-8859-1')

# remove current text/plain part
msg.parts.reject! { |part| part == msg.text_part }
# and replace with ours
msg.text_part =  Mail::Part::new do
  content_type 'text/plain; charset=iso-8859-1'
  body text
end

puts msg
